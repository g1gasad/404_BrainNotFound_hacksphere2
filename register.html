<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - MaterCare</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .register-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg) var(--spacing-sm);
        }

        .register-hero {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xl) 0;
            background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)),
                        url('https://placehold.co/1200x800/9ac1f0/ffffff?text=MaterCare+Registration') center/cover;
            border-radius: var(--radius-lg);
        }

        .register-hero h1 {
            color: var(--primary-color);
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }

        .register-hero p {
            color: var(--text-color);
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.8rem;
            line-height: 1.6;
        }

        .register-form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .user-type-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--light-color);
        }

        .user-type-card {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .user-type-card:hover {
            transform: translateY(-5px);
        }

        .user-type-card.active {
            border-color: var(--primary-color);
            background: var(--light-color);
        }

        .user-type-icon {
            width: 60px;
            height: 60px;
            background: var(--light-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-md);
            color: var(--primary-color);
            font-size: 2.4rem;
        }

        .user-type-card.active .user-type-icon {
            background: var(--primary-color);
            color: white;
        }

        .user-type-card h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .user-type-card p {
            color: var(--text-color);
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--gray-color);
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: var(--spacing-sm);
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--tertiary-color);
        }

        .form-buttons {
            text-align: center;
            margin-top: var(--spacing-lg);
        }

        .section-title {
            color: var(--primary-color);
            margin: var(--spacing-md) 0;
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--gray-color);
        }

        .success-message, .error-message {
            margin: var(--spacing-md) 0;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            text-align: center;
            display: none;
        }
        
        .success-message {
            background-color: rgba(var(--success-rgb), 0.1);
            color: var(--success-color);
        }
        
        .error-message {
            background-color: rgba(var(--danger-rgb), 0.1);
            color: var(--danger-color);
        }
        
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border-radius: 50%;
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .type-fields {
            display: none;
        }

        .form-content {
            padding: var(--spacing-lg);
        }

        .login-link {
            text-align: center;
            margin-top: var(--spacing-md);
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .login-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <div class="container">
            <div class="logo">
               
                <h1>GarbhSeva</h1>
            </div>
            <nav class="nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="resources.html">Resources</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <a href="register.html" class="btn btn-primary active">Register</a>
            </div>
            <div class="language-selector">
                <select id="language">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="hi">हिंदी</option>
                    <option value="fr">Français</option>
                </select>
            </div>
            <div class="mobile-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <!-- Register Section -->
    <section class="register-section">
        <div class="register-container">
            <div class="register-hero">
                <h1>Join MaterCare</h1>
                <p>Create your account to access comprehensive maternal healthcare services and support.</p>
            </div>

            <div class="register-form-container">
                <div class="form-content">
                    <div class="loading-spinner"></div>
                    <div class="success-message"></div>
                    <div class="error-message"></div>

                    <!-- Register Form -->
                    <form id="registerForm">
                        <div class="user-type-selection">
                            <div class="user-type-card active" data-type="mother">
                                <div class="user-type-icon">
                                    <i class="fas fa-female"></i>
                                </div>
                                <h3>Expectant Mother</h3>
                                <p>Access healthcare services</p>
                            </div>
                            <div class="user-type-card" data-type="doctor">
                                <div class="user-type-icon">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <h3>Healthcare Provider</h3>
                                <p>Provide maternal care</p>
                            </div>
                            <div class="user-type-card" data-type="ngo">
                                <div class="user-type-icon">
                                    <i class="fas fa-hands-helping"></i>
                                </div>
                                <h3>NGO/Organization</h3>
                                <p>Support maternal health</p>
                            </div>
                        </div>

                        <h3 class="section-title">Account Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name *</label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name *</label>
                                <input type="text" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">Password *</label>
                                <div class="password-input">
                                    <input type="password" id="password" name="password" required>
                                    <i class="fas fa-eye password-toggle"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password *</label>
                                <div class="password-input">
                                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                                    <i class="fas fa-eye password-toggle"></i>
                                </div>
                            </div>
                        </div>

                        <h3 class="section-title">Profile Details</h3>
                        
                        <!-- Mother-specific fields -->
                        <div class="type-fields mother-fields" style="display: block;">
                            <!-- All mother-specific fields removed as per requirement -->
                        </div>

                        <!-- Doctor-specific fields -->
                        <div class="type-fields doctor-fields">
                            <!-- All doctor-specific fields removed as per requirement -->
                        </div>

                        <!-- NGO-specific fields -->
                        <div class="type-fields ngo-fields">
                            <!-- All NGO-specific fields removed as per requirement -->
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="termsAccept" required>
                                I agree to the <a href="terms.html">Terms of Service</a> and <a href="privacy.html">Privacy Policy</a>
                            </label>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Complete Registration</button>
                        </div>

                        <div class="login-link">
                            Already registered? <a href="index.html">Go to Home Page</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-logo">
                    <img src="images/logo.png" alt="MaterCare Logo">
                    <h3>MaterCare</h3>
                    <p>Bridging the gap in maternal healthcare</p>
                </div>
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="services.html">Services</a></li>
                        <li><a href="resources.html">Resources</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Our Services</h4>
                    <ul>
                        <li><a href="emergency.html">Emergency Support</a></li>
                        <li><a href="health-tracker.html">Health Tracking</a></li>
                        <li><a href="consultation.html">Consultation</a></li>
                        <li><a href="resources.html">Educational Resources</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>Contact Us</h4>
                    <p><i class="fas fa-envelope"></i> info@matercare.org</p>
                    <p><i class="fas fa-phone"></i> +91 1234567890</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 MaterCare. All rights reserved.</p>
                <div class="footer-policies">
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Make Supabase globally available - check what's available
        console.log('CDN Supabase object:', supabase);
        window.supabaseJs = supabase;
    </script>
    <script type="module">
        import { signUp } from './js/supabase.js';
        import { insertUserProfile, insertMotherData, insertDoctorData, insertNgoData, testDatabaseConnection } from './js/supabase-db.js';
        
        // Import the Supabase client to use in this script
        import { supabase } from './js/supabase.js';
        
        // Log the imported supabase client for debugging
        console.log('Imported Supabase client:', supabase);

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Test database connection
                const { connected, error } = await testDatabaseConnection();
                if (!connected) {
                    console.error('Database connection issue:', error);
                    showMessage(error, 'error');
                    document.querySelectorAll('button[type="submit"]').forEach(btn => {
                        btn.disabled = true;
                    });
                } else {
                    console.log('Database connection successful');
                }

                // Set up user type selection
                document.querySelectorAll('.user-type-card').forEach(card => {
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.user-type-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        
                        const userType = card.dataset.type;
                        document.querySelectorAll('.type-fields').forEach(field => {
                            field.style.display = 'none';
                        });
                        document.querySelector(`.${userType}-fields`).style.display = 'block';
                    });
                });

                // Password toggle functionality
                document.querySelectorAll('.password-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const input = toggle.previousElementSibling;
                        if (input.type === 'password') {
                            input.type = 'text';
                            toggle.classList.remove('fa-eye');
                            toggle.classList.add('fa-eye-slash');
                        } else {
                            input.type = 'password';
                            toggle.classList.remove('fa-eye-slash');
                            toggle.classList.add('fa-eye');
                        }
                    });
                });

                // Handle form submission
                document.getElementById('registerForm').addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    // Show loading spinner
                    showLoading(true);
                    
                    // Get user data
                    const userType = document.querySelector('.user-type-card.active').dataset.type;
                    const formData = {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value,
                        confirmPassword: document.getElementById('confirmPassword').value
                    };

                    // Basic validation
                    if (!formData.email || !formData.password) {
                        showMessage('Email and password are required', 'error');
                        showLoading(false);
                        return;
                    }

                    if (formData.password !== formData.confirmPassword) {
                        showMessage('Passwords do not match', 'error');
                        showLoading(false);
                        return;
                    }

                    try {
                        console.log(`Registering new ${userType}:`, formData);
                        
                        // Register user with Supabase
                        const { data, error } = await signUp(
                            formData.email,
                            formData.password,
                            userType,
                            {
                                first_name: formData.firstName,
                                last_name: formData.lastName
                            }
                        );

                        if (error) throw error;
                        
                        if (!data || !data.user || !data.user.id) {
                            throw new Error('User registration successful but no user ID was returned');
                        }
                        
                        const userId = data.user.id;
                        console.log('User registered with ID:', userId);
                        
                        // Insert user profile
                        const profileData = {
                            first_name: formData.firstName,
                            last_name: formData.lastName,
                            email: formData.email,
                            user_type: userType,
                            user_id: userId
                        };
                        
                        console.log('Attempting to insert user profile with data:', profileData);
                        
                        try {
                            // Direct database insertion bypassing RLS
                            // Create a direct database connection for the profile insertion
                            const directSupabase = window.supabaseJs.createClient(
                                'https://zcsfvycqhsgxcbwxtiit.supabase.co',
                                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpjc2Z2eWNxaHNneGNid3h0aWl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2Mjk2ODYsImV4cCI6MjA1ODIwNTY4Nn0.dxXTaAyI-ZD6YX4XNJvchc4sW-tJJYu7gVjXa-fi3Zo'
                            );
                            
                            console.log('Direct supabase client created:', directSupabase);
                            
                            // First check if user profile already exists
                            const { data: existingProfile } = await directSupabase
                                .from('user_profiles')
                                .select('id')
                                .eq('email', formData.email)
                                .maybeSingle();
                                
                            if (existingProfile) {
                                console.log('Profile already exists with this email:', formData.email);
                                throw new Error('A user with this email already exists.');
                            }
                            
                            // Insert the user profile
                            const { data: profileResult, error: profileError } = await directSupabase
                                .from('user_profiles')
                                .insert([profileData])
                                .select();
                            
                            if (profileError) {
                                console.error('Error inserting user profile:', profileError);
                                console.error('Profile insertion error details:', JSON.stringify(profileError));
                                
                                // Try updating auth metadata as a fallback
                                const { error: metadataError } = await directSupabase.auth.updateUser({
                                    data: { 
                                        first_name: formData.firstName,
                                        last_name: formData.lastName,
                                        user_type: userType
                                    }
                                });
                                
                                if (metadataError) {
                                    throw profileError; // Use original error if metadata update also fails
                                } else {
                                    console.log('Updated user metadata as fallback');
                                }
                            } else {
                                console.log('Successfully inserted user profile:', profileResult);
                            }
                            
                            // Insert type-specific data
                            if (userType === 'mother') {
                                const motherData = {
                                    user_id: userId // Add user_id explicitly
                                };
                                
                                console.log('Storing minimal mother data:', motherData);
                                try {
                                    // Insert directly using the directSupabase client
                                    const { data: motherResult, error: motherError } = await directSupabase
                                        .from('mothers')
                                        .insert([motherData])
                                        .select();
                                        
                                    if (motherError) {
                                        console.error('Error inserting mother data:', motherError);
                                        // Try updating metadata as fallback
                                        await directSupabase.auth.updateUser({
                                            data: { mother_data: true }
                                        });
                                        console.log('Stored minimal mother data in user metadata as fallback');
                                    } else {
                                        console.log('Successfully inserted minimal mother data:', motherResult);
                                    }
                                } catch (motherErr) {
                                    console.error('Mother data insertion error:', motherErr);
                                }
                            } else if (userType === 'doctor') {
                                const doctorData = {
                                    user_id: userId // Add user_id explicitly
                                };
                                
                                console.log('Storing minimal doctor data:', doctorData);
                                try {
                                    // Insert directly using the directSupabase client
                                    const { data: doctorResult, error: doctorError } = await directSupabase
                                        .from('doctors')
                                        .insert([doctorData])
                                        .select();
                                        
                                    if (doctorError) {
                                        console.error('Error inserting doctor data:', doctorError);
                                        // Try updating metadata as fallback
                                        await directSupabase.auth.updateUser({
                                            data: { doctor_data: true }
                                        });
                                        console.log('Stored minimal doctor data in user metadata as fallback');
                                    } else {
                                        console.log('Successfully inserted minimal doctor data:', doctorResult);
                                    }
                                } catch (doctorErr) {
                                    console.error('Doctor data insertion error:', doctorErr);
                                }
                            } else if (userType === 'ngo') {
                                const ngoData = {
                                    user_id: userId // Add user_id explicitly
                                };
                                
                                console.log('Storing minimal NGO data:', ngoData);
                                try {
                                    // Insert directly using the directSupabase client
                                    const { data: ngoResult, error: ngoError } = await directSupabase
                                        .from('ngos')
                                        .insert([ngoData])
                                        .select();
                                        
                                    if (ngoError) {
                                        console.error('Error inserting NGO data:', ngoError);
                                        // Try updating metadata as fallback
                                        await directSupabase.auth.updateUser({
                                            data: { ngo_data: true }
                                        });
                                        console.log('Stored minimal NGO data in user metadata as fallback');
                                    } else {
                                        console.log('Successfully inserted minimal NGO data:', ngoResult);
                                    }
                                } catch (ngoErr) {
                                    console.error('NGO data insertion error:', ngoErr);
                                }
                            }

                            // Show success message and redirect
                            showMessage('Registration successful! Redirecting to home page...', 'success');
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 2000);
                            
                            return; // Skip the rest of the insertion process
                        } catch (err) {
                            console.error('Profile insertion try-catch error:', err);
                            // Continue with other insertion attempts
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        let errorMessage = 'Registration failed: ';
                        
                        if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                            errorMessage += 'Database tables are not set up correctly. Please ensure you have run the SQL setup script.';
                        } else if (error.code === '23505') {
                            errorMessage += 'A user with this email already exists.';
                        } else if (error.code === '23503') {
                            errorMessage += 'Foreign key constraint failed. User may not exist in the auth table.';
                        } else if (error.message && error.message.includes('duplicate key')) {
                            errorMessage += 'This email is already registered.';
                        } else {
                            errorMessage += error.message || 'Unknown error';
                        }
                        
                        // Show detailed technical error in console for debugging
                        console.error('Detailed error information:', {
                            code: error.code,
                            message: error.message,
                            details: error.details,
                            hint: error.hint
                        });
                        
                        showMessage(errorMessage, 'error');
                    } finally {
                        showLoading(false);
                    }
                });

            } catch (error) {
                console.error('Initialization error:', error);
                showMessage(`Initialization error: ${error.message}`, 'error');
            }
        });

        // Helper functions
        function showMessage(message, type) {
            const messageElement = document.querySelector(`.${type}-message`);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }
    </script>
</body>
</html> 